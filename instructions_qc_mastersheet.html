<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-alpha/dist/katex.min.css" integrity="sha384-BTL0nVi8DnMrNdMQZG1Ww6yasK9ZGnUxL1ZWukXQ7fygA1py52yPp9W4wrR00VML" crossorigin="anonymous">
        <style>
/*--------------------------------------------------------------------------------------------- * Copyright (c) Microsoft Corporation. All rights reserved. * Licensed under the MIT License. See License.txt in the project root for license information. *--------------------------------------------------------------------------------------------*/ body { font-family: "Segoe WPC", "Segoe UI", "SFUIText-Light", "HelveticaNeue-Light", sans-serif, "Droid Sans Fallback"; font-size: 14px; padding: 0 26px; line-height: 22px; word-wrap: break-word; } #code-csp-warning { position: fixed; top: 0; right: 0; color: white; margin: 16px; text-align: center; font-size: 12px; font-family: sans-serif; background-color:#444444; cursor: pointer; padding: 6px; box-shadow: 1px 1px 1px rgba(0,0,0,.25); } #code-csp-warning:hover { text-decoration: none; background-color:#007acc; box-shadow: 2px 2px 2px rgba(0,0,0,.25); } body.scrollBeyondLastLine { margin-bottom: calc(100vh - 22px); } body.showEditorSelection .code-line { position: relative; } body.showEditorSelection .code-active-line:before, body.showEditorSelection .code-line:hover:before { content: ""; display: block; position: absolute; top: 0; left: -12px; height: 100%; } body.showEditorSelection li.code-active-line:before, body.showEditorSelection li.code-line:hover:before { left: -30px; } .vscode-light.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(0, 0, 0, 0.15); } .vscode-light.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(0, 0, 0, 0.40); } .vscode-light.showEditorSelection .code-line .code-line:hover:before { border-left: none; } .vscode-dark.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(255, 255, 255, 0.4); } .vscode-dark.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(255, 255, 255, 0.60); } .vscode-dark.showEditorSelection .code-line .code-line:hover:before { border-left: none; } .vscode-high-contrast.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(255, 160, 0, 0.7); } .vscode-high-contrast.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(255, 160, 0, 1); } .vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before { border-left: none; } img { max-width: 100%; max-height: 100%; } a { text-decoration: none; } a:hover { text-decoration: underline; } a:focus, input:focus, select:focus, textarea:focus { outline: 1px solid -webkit-focus-ring-color; outline-offset: -1px; } hr { border: 0; height: 2px; border-bottom: 2px solid; } h1 { padding-bottom: 0.3em; line-height: 1.2; border-bottom-width: 1px; border-bottom-style: solid; } h1, h2, h3 { font-weight: normal; } h1 code, h2 code, h3 code, h4 code, h5 code, h6 code { font-size: inherit; line-height: auto; } table { border-collapse: collapse; } table > thead > tr > th { text-align: left; border-bottom: 1px solid; } table > thead > tr > th, table > thead > tr > td, table > tbody > tr > th, table > tbody > tr > td { padding: 5px 10px; } table > tbody > tr + tr > td { border-top: 1px solid; } blockquote { margin: 0 7px 0 5px; padding: 0 16px 0 10px; border-left-width: 5px; border-left-style: solid; } code { font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback"; font-size: 14px; line-height: 19px; } body.wordWrap pre { white-space: pre-wrap; } .mac code { font-size: 12px; line-height: 18px; } pre:not(.hljs), pre.hljs code > div { padding: 16px; border-radius: 3px; overflow: auto; } /** Theming */ pre code { color: var(--vscode-editor-foreground); } .vscode-light pre:not(.hljs), .vscode-light code > div { background-color: rgba(220, 220, 220, 0.4); } .vscode-dark pre:not(.hljs), .vscode-dark code > div { background-color: rgba(10, 10, 10, 0.4); } .vscode-high-contrast pre:not(.hljs), .vscode-high-contrast code > div { background-color: rgb(0, 0, 0); } .vscode-high-contrast h1 { border-color: rgb(0, 0, 0); } .vscode-light table > thead > tr > th { border-color: rgba(0, 0, 0, 0.69); } .vscode-dark table > thead > tr > th { border-color: rgba(255, 255, 255, 0.69); } .vscode-light h1, .vscode-light hr, .vscode-light table > tbody > tr + tr > td { border-color: rgba(0, 0, 0, 0.18); } .vscode-dark h1, .vscode-dark hr, .vscode-dark table > tbody > tr + tr > td { border-color: rgba(255, 255, 255, 0.18); } 
</style>
<style>
/* Tomorrow Theme */ /* http://jmblog.github.com/color-themes-for-google-code-highlightjs */ /* Original theme - https://github.com/chriskempson/tomorrow-theme */ /* Tomorrow Comment */ .hljs-comment, .hljs-quote { color: #8e908c; } /* Tomorrow Red */ .hljs-variable, .hljs-template-variable, .hljs-tag, .hljs-name, .hljs-selector-id, .hljs-selector-class, .hljs-regexp, .hljs-deletion { color: #c82829; } /* Tomorrow Orange */ .hljs-number, .hljs-built_in, .hljs-builtin-name, .hljs-literal, .hljs-type, .hljs-params, .hljs-meta, .hljs-link { color: #f5871f; } /* Tomorrow Yellow */ .hljs-attribute { color: #eab700; } /* Tomorrow Green */ .hljs-string, .hljs-symbol, .hljs-bullet, .hljs-addition { color: #718c00; } /* Tomorrow Blue */ .hljs-title, .hljs-section { color: #4271ae; } /* Tomorrow Purple */ .hljs-keyword, .hljs-selector-tag { color: #8959a8; } .hljs { display: block; overflow-x: auto; color: #4d4d4c; padding: 0.5em; } .hljs-emphasis { font-style: italic; } .hljs-strong { font-weight: bold; }
</style>
<style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'HelveticaNeue-Light', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
    </head>
    <body>
        <h1 id="2018-10-26-151841-gs">2018-10-26 15:18:41, GS</h1>
<h2 id="structural">structural</h2>
<p>Start with a simple Query in Labmatrix for Scans of type = MPRAGE. Output all
columns and save the results as CSV.</p>
<p><img src="file:///Users/sudregp/lab_notes/2018-10-26-15-25-53.png" alt=""></p>
<p>Next, we gather the Freesurfer cortical scores from Labmatrix. Again, a simple
Query of QualityControl custom
data, with subsets of Type = Freesurfer5.3_ext_avg OR Type =
Freesurfer5.3_int_avg. Save the results as CSV again.</p>
<p><img src="file:///Users/sudregp/lab_notes/2018-10-26-15-23-59.png" alt=""></p>
<h2 id="dti">DTI</h2>
<p>For DTI, we need to run get_dti_movement.py to get all variables for us. They
are spit out to a file ~/tmp/mean_dti_movement.csv. You can always get the most
recent version of the script from
<a href="https://github.com/gsudre/research_code/blob/master/dti/get_dti_motion.py">https://github.com/gsudre/research_code/blob/master/dti/get_dti_motion.py</a></p>
<p>We need a list of mask ids to call the script, so let's just use the list of all
mask ids we currently have, and the script will take care of letting you know
what it cannot find to have DTI:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># in caterpie</span>
/bin/ls -1 /mnt/shaw/data_by_maskID/ | grep -E <span class="hljs-string">"^....$"</span> &gt; ~/tmp/maskids.txt;
python ~/research_code/dti/get_dti_motion.py ~/tmp/maskids.txt /mnt/shaw/
</div></code></pre>
<p>Note that the first argument to the script is the list of mask ids. All we do
there is list the mask id directory and keep only the entires that have 4 of any
characters (more likely than not, the mask id directories).</p>
<p>To get the mean FA/AD/RD, we need to access the tensors before they go into
DTI-TK, so that whatever processing happens later doesn't affect the QC
estimates. Since this is a crude estimate, we won't skeletonize it, and just
create a mask based on FA values, to be used over all other properties.</p>
<pre class="hljs"><code><div><span class="hljs-comment"># still in caterpie</span>
<span class="hljs-built_in">cd</span> ~/tmp
maskidDir=/mnt/shaw/data_by_maskID/
maskidFile=~/tmp/maskids.txt
<span class="hljs-built_in">echo</span> <span class="hljs-string">"maskid,mean_fa,mean_ad,mean_rd,nvoxInMask"</span> &gt; mean_props.csv;
<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> m; <span class="hljs-keyword">do</span>
    tensorDir=<span class="hljs-variable">${maskidDir}</span>/<span class="hljs-variable">${m}</span>/edti_proc/edti_DMC_DR_R1_SAVE_DTITK/;
    <span class="hljs-keyword">if</span> [ ! -d <span class="hljs-variable">$tensorDir</span> ]; <span class="hljs-keyword">then</span>
        tensorDir=<span class="hljs-variable">${maskidDir}</span>/<span class="hljs-variable">${m}</span>/edti_proc/edti_DMC_R1_SAVE_DTITK/;
        tensorFile=edti_DMC_R1_tensor.nii;
    <span class="hljs-keyword">else</span>
        tensorFile=edti_DMC_DR_R1_tensor.nii;
    <span class="hljs-keyword">fi</span>;
    <span class="hljs-keyword">if</span> [ ! -d <span class="hljs-variable">$tensorDir</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-variable">$tensorDir</span> <span class="hljs-string">"does not exist. Skipping..."</span>
    <span class="hljs-keyword">else</span>
        TVtool -<span class="hljs-keyword">in</span> <span class="hljs-variable">${tensorDir}</span>/<span class="hljs-variable">${tensorFile}</span> -fa -out ./fa.nii;
        TVtool -<span class="hljs-keyword">in</span> <span class="hljs-variable">${tensorDir}</span>/<span class="hljs-variable">${tensorFile}</span> -ad -out ./ad.nii;
        TVtool -<span class="hljs-keyword">in</span> <span class="hljs-variable">${tensorDir}</span>/<span class="hljs-variable">${tensorFile}</span> -rd -out ./rd.nii;
        3dcalc -a fa.nii -prefix mymask.nii -overwrite -expr <span class="hljs-string">"step(a-.2)"</span>;
        fa=`3dmaskave -q -mask mymask.nii fa.nii`;
        ad=`3dmaskave -q -mask mymask.nii ad.nii`;
        rd=`3dmaskave -q -mask mymask.nii rd.nii`;
        nvox=`3dBrickStat -count -non-zero mymask.nii`;
        <span class="hljs-built_in">echo</span> <span class="hljs-variable">${m}</span>,<span class="hljs-variable">${fa}</span>,<span class="hljs-variable">${ad}</span>,<span class="hljs-variable">${rd}</span>,<span class="hljs-variable">${nvox}</span> &gt;&gt; mean_props.csv;
    <span class="hljs-keyword">fi</span>;
<span class="hljs-keyword">done</span> &lt; <span class="hljs-variable">$maskidFile</span>
</div></code></pre>
<h2 id="rsfmri">rsFMRI</h2>
<p>Finally, to gather the fMRI parameters we do (using the same list of all mask
ids used for DTI):</p>
<pre class="hljs"><code><div><span class="hljs-comment"># again in caterpie</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"maskid,totalTRs,usedTRs,enormGoodTRs"</span> &gt; ~/tmp/good_trs.csv;
<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> s; <span class="hljs-keyword">do</span>
    mydir=/mnt/shaw/data_by_maskID/<span class="hljs-variable">${s}</span>/afni/<span class="hljs-variable">${s}</span>.rest.subjectSpace.results;
    <span class="hljs-keyword">if</span> [ -e <span class="hljs-variable">${mydir}</span>/errts.<span class="hljs-variable">${s}</span>.fanaticor+orig.HEAD ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-variable">$s</span>;
        used=`1d_tool.py -infile <span class="hljs-variable">${mydir}</span>//X.xmat.1D -show_rows_cols -verb 0 | cut -d <span class="hljs-string">" "</span> -f 1 -`;
        <span class="hljs-keyword">if</span> [ -e <span class="hljs-variable">${mydir}</span>//X.nocensor.xmat.1D ]; <span class="hljs-keyword">then</span>
            total=`1d_tool.py -infile <span class="hljs-variable">${mydir}</span>//X.nocensor.xmat.1D -show_rows_cols -verb 0 | cut -d <span class="hljs-string">" "</span> -f 1 -`;
        <span class="hljs-keyword">else</span>
            total=<span class="hljs-variable">$used</span>;
        <span class="hljs-keyword">fi</span>;
        1deval -a <span class="hljs-variable">${mydir}</span>/motion_<span class="hljs-variable">${s}</span>_enorm.1D \
               -b <span class="hljs-variable">${mydir}</span>/censor_<span class="hljs-variable">${s}</span>_combined_2.1D \
               -expr <span class="hljs-string">'a*b'</span> &gt; ~/tmp/rm.ec.1D;
        mvmt=`3dTstat -prefix - -nzmean ~/tmp/rm.ec.1D\<span class="hljs-string">' 2&gt;/dev/null`;
        echo ${s},${total},${used},${mvmt} &gt;&gt; ~/tmp/good_trs.csv;
    else
        echo $m "does not have rsFMRI results. Skipping...";
    fi;
done &lt; ~/tmp/maskids.txt
</span></div></code></pre>
<p>Then run the same thing for the .05 results.</p>
<h2 id="combining-everything">combining everything</h2>
<p>Finally, in R we can merge everything:</p>
<pre class="hljs"><code><div>mprage_fname = <span class="hljs-string">'~/Downloads/mprage.csv'</span>
fs_fname = <span class="hljs-string">'~/Downloads/fs.csv'</span>
dti_fname = <span class="hljs-string">'~/tmp/mean_dti_movement.csv'</span>
dtiprops_fname = <span class="hljs-string">'~/tmp/mean_props.csv'</span>
fmri01_fname = <span class="hljs-string">'~/tmp/good_trs.csv'</span>
fmri05_fname = <span class="hljs-string">'~/tmp/good_trs.csv'</span>
out_fname = <span class="hljs-string">'~/tmp/master_qc.csv'</span>

mprage = read.csv(mprage_fname)
<span class="hljs-comment"># collapse the mprage scores to only get the best one</span>
best_mprage = do.call(rbind, by(mprage, mprage$Mask.ID, <span class="hljs-keyword">function</span>(x) x[which.min(x$QC), ] ))
best_mprage = best_mprage[, c(<span class="hljs-string">'Mask.ID'</span>, <span class="hljs-string">'QC'</span>)]
colnames(best_mprage)[<span class="hljs-number">2</span>] = <span class="hljs-string">'mprage_QC'</span>
fs = read.csv(fs_fname)
<span class="hljs-comment"># same thing, but now for Freesurfer internal and external</span>
fs_ext = fs[fs$Type==<span class="hljs-string">'Freesurfer5.3_ext_avg'</span>,]
fs_ext = do.call(rbind, by(fs_ext, fs_ext$Mask.ID, <span class="hljs-keyword">function</span>(x) x[which.min(x$Score), ] ))
fs_ext = fs_ext[, c(<span class="hljs-string">'Mask.ID'</span>, <span class="hljs-string">'Score'</span>)]
colnames(fs_ext)[<span class="hljs-number">2</span>] = <span class="hljs-string">'ext_avg_freesurfer5.3'</span>
fs_int = fs[fs$Type==<span class="hljs-string">'Freesurfer5.3_int_avg'</span>,]
fs_int = do.call(rbind, by(fs_int, fs_int$Mask.ID, <span class="hljs-keyword">function</span>(x) x[which.min(x$Score), ] ))
fs_int = fs_int[, c(<span class="hljs-string">'Mask.ID'</span>, <span class="hljs-string">'Score'</span>)]
colnames(fs_int)[<span class="hljs-number">2</span>] = <span class="hljs-string">'int_avg_freesurfer5.3'</span>
<span class="hljs-comment"># for fMRI and DTI it's just a matter of opening them and renaming a few</span>
<span class="hljs-comment"># variables to make it a bit more elegant</span>
dti = read.csv(dti_fname)
dti = dti[, <span class="hljs-number">1</span>:(ncol(dti)-<span class="hljs-number">2</span>)]  <span class="hljs-comment"># we don't need to know which slices were removed</span>
colnames(dti)[<span class="hljs-number">1</span>] = <span class="hljs-string">'Mask.ID'</span>
dtiprops = read.csv(dtiprops_fname)
colnames(dtiprops)[<span class="hljs-number">1</span>] = <span class="hljs-string">'Mask.ID'</span>
fmri01 = read.csv(fmri01_fname)
colnames(fmri01) = sapply(colnames(fmri01), <span class="hljs-keyword">function</span>(x) sprintf(<span class="hljs-string">'%s_fmri01'</span>, x))
colnames(fmri01)[<span class="hljs-number">1</span>] = <span class="hljs-string">'Mask.ID'</span>
fmri05 = read.csv(fmri05_fname)
colnames(fmri05) = sapply(colnames(fmri01), <span class="hljs-keyword">function</span>(x) sprintf(<span class="hljs-string">'%s_fmri05'</span>, x))
colnames(fmri05)[<span class="hljs-number">1</span>] = <span class="hljs-string">'Mask.ID'</span>
<span class="hljs-comment"># finally, do a big'ol merge on everything</span>
m = merge(best_mprage, fs_ext, by=<span class="hljs-string">'Mask.ID'</span>, all.x=<span class="hljs-literal">T</span>, all.y=<span class="hljs-literal">T</span>)
m = merge(m, fs_int, by=<span class="hljs-string">'Mask.ID'</span>, all.x=<span class="hljs-literal">T</span>, all.y=<span class="hljs-literal">T</span>)
m = merge(m, dti, by=<span class="hljs-string">'Mask.ID'</span>, all.x=<span class="hljs-literal">T</span>, all.y=<span class="hljs-literal">T</span>)
m = merge(m, dtiprops, by=<span class="hljs-string">'Mask.ID'</span>, all.x=<span class="hljs-literal">T</span>, all.y=<span class="hljs-literal">T</span>)
m = merge(m, fmri01, by=<span class="hljs-string">'Mask.ID'</span>, all.x=<span class="hljs-literal">T</span>, all.y=<span class="hljs-literal">T</span>)
m = merge(m, fmri05, by=<span class="hljs-string">'Mask.ID'</span>, all.x=<span class="hljs-literal">T</span>, all.y=<span class="hljs-literal">T</span>)
write.csv(m, file=out_fname, row.names=<span class="hljs-literal">F</span>)
</div></code></pre>
<h2 id="appending-new-ids">Appending new IDs</h2>
<p>These instructions show you how to collect QC metrics for a set of mask ids.
This could be the complete set you're playing with or just a subset, to later be
concatenated to a master list. Choose your own destiny.</p>

    </body>
    </html>